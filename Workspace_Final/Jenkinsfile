pipeline {
  agent {
    docker {
      image 'docker:20-dind'
      args '--privileged -v /var/run/docker.sock:/var/run/docker.sock'
    }
  }

  environment {
    NODE_VERSION = '20-alpine'
    DOCKERHUB_CREDENTIALS = credentials('dockerhub-cred-id')
    DOCKERHUB_USERNAME = 'khangdinh2103'
  }

  stages {

    stage('Setup Environment') {
      steps {
        sh 'apk add --no-cache curl git'
      }
    }
    
    stage('Checkout') {
      steps {
        git branch: 'master', url: 'https://github.com/khangdinh2103/Microservices_Jewelry_eCommerce_FE.git'
      }
    }

    // stage('Prepare Directories') {
    //   steps {
    //     dir('Workspace_Final') {
    //       script {
    //         // Create necessary directories if they don't exist
    //         sh '''
    //           mkdir -p Container/container-vite
    //           mkdir -p Service_Account/service-account-vite
    //           mkdir -p Service_Catalog/service-catalog-vite
    //           mkdir -p Service_Cart_Order/service-cart-order-vite
    //         '''
    //         // No package.json creation as requested
    //       }
    //     }
    //   }
    // }

    stage('Build & Start Services') {
      steps {
        dir('Workspace_Final') {
          script {
            sh 'docker-compose build'
            sh 'docker-compose up -d'
            
            // Check if services are running
            sh 'docker-compose ps'
            
            // Wait for services to initialize
            echo "Waiting for services to start..."
            sleep(time: 60, unit: 'SECONDS')
            
            // Check logs
            sh 'docker-compose logs --tail=50'
            
            // Check again if services are running
            sh 'docker-compose ps'
          }
        }
      }
    }

    stage('Create and Push Docker Images') {
      steps {
        dir('Workspace_Final') {
          script {
            def services = ['container', 'service-account', 'service-catalog', 'service-cart-order']
            
            // Login to Docker Hub once before the loop
            withCredentials([usernamePassword(credentialsId: 'dockerhub-cred-id', passwordVariable: 'DOCKER_PASSWORD', usernameVariable: 'DOCKER_USERNAME')]) {
              sh """
                echo "Login to Docker Hub"
                echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin || echo 'Failed to login'
              """
            }
            
            services.each { serviceName ->
              echo "Processing ${serviceName}..."
              
              def containerExists = sh(
                script: "docker-compose ps -q ${serviceName} || echo ''",
                returnStdout: true
              ).trim()
              
              if (containerExists) {
                def imageName = "${DOCKERHUB_USERNAME}/${serviceName}"
                
                sh "docker commit ${containerExists} ${imageName}:latest || echo 'Failed to commit container'"
                
                sh """
                  # Try to push the image
                  docker push ${imageName}:latest || echo 'Failed to push image'
                """
                
                echo "Processed ${serviceName}"
              } else {
                echo "Container for ${serviceName} not found, skipping"
              }
            }
            
            sh "docker logout"
          }
        }
      }
    }
  }

  post {
    always {
      echo 'Pipeline completed - keeping containers running'
      // Removed the docker-compose down command to keep containers running
    }
    success {
      echo 'Pipeline completed successfully!'
    }
    failure {
      echo 'Pipeline failed. Check the logs for details.'
    }
  }
}